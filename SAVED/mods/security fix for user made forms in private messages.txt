Fix for user created form security hole in private messages

model\domainmodel\privatemessage

resources/service/messageservice
namespace Service\ApplicationService;
use HTMLPurifier;
use Model\DomainModel\Member;
use Model\DomainModel\PrivateMessage;
use Resource\Collection\ArrayList;
use Resource\Core\Registry;
use Resource\Exception\InvalidActionException;
use Resource\Native\MysObject;

    private $htmlPurifier;

    public function __construct($mid = 0, $folder = "inbox", $dto = NULL, $notifier = FALSE, $htmlPurifier = TRUE){
        $mysidia = Registry::get("mysidia");
        if($htmlPurifier) $this->htmlPurifier = new HTMLPurifier;  
        if($mid == 0){
            //This is a new private message not yet exist in database
            $this->mid = $mid;
            $this->fromuser = $mysidia->user->getID();
            $this->folder = ($folder == "inbox") ? $this->folder : $folder;
            return;
        }
        elseif(!$dto){
            // The private message is not being composed, so fetch the information from database
            $table = ($folder == "inbox") ? "messages" : "folders_messages";
            $dto = $mysidia->db->select($table, [], "mid = :mid", ["mid" => $mid])->fetchObject();
            if(!is_object($dto)) throw new MessageNotfoundException("The message does not exist in database.");            
        }
        parent::__construct($dto);
        if($notifier == TRUE) $this->getNotifier();    
    }

Then go to the post function and replace the rawPost part with this:
	    if($this->htmlPurifier){
            $this->messagetext = $this->htmlPurifier->purify($this->format($mysidia->input->rawPost("mtext")));
            $mysidia->db->insert("messages", ["mid" => NULL, "fromuser" => $this->fromuser, "touser" => $this->touser, "status" => "unread", "datesent" => $date->format("Y-m-d"), "messagetitle" => $this->messagetitle, "messagetext" => $this->messagetext]);
        }else{
            $this->messagetext = $this->htmlPurifier->purify($this->format($mysidia->input->post("mtext")));
            $mysidia->db->insert("messages", ["mid" => NULL, "fromuser" => $this->fromuser, "touser" => $this->touser, "status" => "unread", "datesent" => $date->format("Y-m-d"), "messagetitle" => $this->messagetitle, "messagetext" => $this->messagetext]);
        }
